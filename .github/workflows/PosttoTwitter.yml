name: Post to Twitter
on:
  push:
    branches: [ main ]
  workflow_dispatch: 

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整历史，确保 diff 准确

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install tweepy

      - name: Get latest post and Tweet
        env:
          TWITTER_CONSUMER_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          TWITTER_CONSUMER_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          python - <<EOF
          import os
          import tweepy
          import subprocess
          import glob

          def get_target_file():
              # 尝试通过 git diff 获取变更
              try:
                  diff = subprocess.check_output(['git', 'diff', '--name-only', 'HEAD^', 'HEAD']).decode('utf-8')
                  files = [f for f in diff.split('\n') if f.startswith('content/posts/') and f.endswith('.md')]
                  if files:
                      print(f"Git Diff 发现文件: {files[0]}")
                      return files[0]
              except:
                  pass

              # 备选方案：如果 diff 没找到，直接找 content/posts 下最新修改的 .md 文件
              all_md = glob.glob('content/posts/**/*.md', recursive=True)
              if all_md:
                  latest_file = max(all_md, key=os.path.getmtime)
                  print(f"备选方案发现最新文件: {latest_file}")
                  return latest_file
              return None

          target_file = get_target_file()
          if not target_file:
              print("未发现任何文章，跳过。")
              exit(0)

          # 提取标题
          title = "New Post"
          with open(target_file, 'r', encoding='utf-8') as f:
              for line in f:
                  if line.startswith('title:'):
                      title = line.replace('title:', '').strip().strip('"').strip("'")
                      break

          # 构造 URL
          path_parts = target_file.split('/')
          # 处理 content/posts/folder/index.md 或 content/posts/file.md
          if path_parts[-1] in ["index.md", "_index.md"]:
              slug = path_parts[-2] # 取文件夹名
          else:
              slug = path_parts[-1].replace('.md', '')
          
          url = f"https://zhitong.uk/posts/{slug}/"
          content = f"{title}\n{url}"

          print(f"准备发布内容:\n{content}")

          try:
              client = tweepy.Client(
                  consumer_key=os.environ['TWITTER_CONSUMER_KEY'],
                  consumer_secret=os.environ['TWITTER_CONSUMER_SECRET'],
                  access_token=os.environ['TWITTER_ACCESS_TOKEN'],
                  access_token_secret=os.environ['TWITTER_ACCESS_TOKEN_SECRET']
              )
              client.create_tweet(text=content)
              print("✅ 推文发布成功！")
          except Exception as e:
              print(f"❌ 发布失败: {e}")
              # 如果还是 402，说明是 X 账户权限/额度问题，不是代码问题
              exit(1)
          EOF