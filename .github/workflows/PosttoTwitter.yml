name: Post to Twitter with Image
on:
  push:
    branches: [ main ]
  workflow_dispatch: 

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install tweepy

      - name: Get latest post and Tweet
        env:
          TWITTER_CONSUMER_KEY: ${{ secrets.TWITTER_CONSUMER_KEY }}
          TWITTER_CONSUMER_SECRET: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          TWITTER_ACCESS_TOKEN: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          TWITTER_ACCESS_TOKEN_SECRET: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
        run: |
          python - <<EOF
          import os
          import tweepy
          import subprocess
          import glob

          def get_target_file():
              try:
                  diff = subprocess.check_output(['git', 'diff', '--name-only', 'HEAD^', 'HEAD']).decode('utf-8')
                  files = [f for f in diff.split('\n') if f.startswith('content/posts/') and f.endswith('.md')]
                  if files: return files[0]
              except: pass
              all_md = glob.glob('content/posts/**/*.md', recursive=True)
              return max(all_md, key=os.path.getmtime) if all_md else None

          target_file = get_target_file()
          if not target_file:
              print("未发现文章。")
              exit(0)

          # 1. 提取标题和图片路径
          title = "New Post"
          image_path = "static/images/default-share.png"  # 这里设置你的默认图片本地路径
          
          with open(target_file, 'r', encoding='utf-8') as f:
              for line in f:
                  if line.startswith('title:'):
                      title = line.replace('title:', '').strip().strip('"').strip("'")
                  if line.startswith('image:'): # 尝试从 front matter 获取文章自定义图片
                      custom_img = line.replace('image:', '').strip().strip('"').strip("'")
                      # 如果是相对路径，可能需要拼接，这里假设图片在 static 下
                      full_custom_path = os.path.join('static', custom_img.lstrip('/'))
                      if os.path.exists(full_custom_path):
                          image_path = full_custom_path

          # 2. 构造 URL
          path_parts = target_file.split('/')
          slug = path_parts[-2] if path_parts[-1] in ["index.md", "_index.md"] else path_parts[-1].replace('.md', '')
          url = f"https://zhitong.uk/posts/{slug}/"
          tweet_content = f"{title}\n{url}"

          # 3. 认证并发布
          try:
              # 图片上传必须使用 v1.1 认证
              auth = tweepy.OAuth1UserHandler(
                  os.environ['TWITTER_CONSUMER_KEY'], os.environ['TWITTER_CONSUMER_SECRET'],
                  os.environ['TWITTER_ACCESS_TOKEN'], os.environ['TWITTER_ACCESS_TOKEN_SECRET']
              )
              api_v1 = tweepy.API(auth)
              
              # 发帖建议使用 v2
              client_v2 = tweepy.Client(
                  consumer_key=os.environ['TWITTER_CONSUMER_KEY'],
                  consumer_secret=os.environ['TWITTER_CONSUMER_SECRET'],
                  access_token=os.environ['TWITTER_ACCESS_TOKEN'],
                  access_token_secret=os.environ['TWITTER_ACCESS_TOKEN_SECRET']
              )

              # 第一步：上传图片
              print(f"正在上传图片: {image_path}")
              media = api_v1.media_upload(filename=image_path)
              media_id = media.media_id

              # 第二步：发布带图片的推文
              client_v2.create_tweet(text=tweet_content, media_ids=[media_id])
              print("✅ 带图片的推文发布成功！")
              
          except Exception as e:
              print(f"❌ 发布失败: {e}")
              exit(1)
          EOF