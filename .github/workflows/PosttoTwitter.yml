name: Post to Twitter
on:
  push:
    branches: [ main ]
  workflow_dispatch: 

jobs:
  tweet:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get latest post info
        id: post_info
        run: |
          # 查找 content/posts/ 目录下新增或修改的 .md 文件
          FILE=$(git diff --name-only HEAD^ HEAD | grep 'content/posts/.*\.md' | head -n 1)
          
          if [ -z "$FILE" ]; then
            echo "未检测到新文章提交，跳过发帖。"
            exit 0
          fi
          
          # 提取标题并处理引号
          TITLE=$(grep '^title: ' "$FILE" | head -1 | sed 's/title: //;s/"//g;s/'\''//g')
          
          # 获取文件名作为 Slug
          SLUG=$(basename "$FILE" .md)
          URL="https://zhitong.uk/posts/$SLUG/"
          
          echo "tweet_text=$TITLE $URL" >> $GITHUB_OUTPUT
          echo "准备发布的推文: $TITLE $URL"

      - name: Send Tweet
        if: steps.post_info.outputs.tweet_text != ''
        # 使用这个更稳定的 Action
        uses: bluebird-back/twitter-post-action@v1
        with:
          twitter_consumer_key: ${{ secrets.TWITTER_CONSUMER_KEY }}
          twitter_consumer_secret: ${{ secrets.TWITTER_CONSUMER_SECRET }}
          twitter_access_token: ${{ secrets.TWITTER_ACCESS_TOKEN }}
          twitter_access_token_secret: ${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}
          twitter_status: ${{ steps.post_info.outputs.tweet_text }}